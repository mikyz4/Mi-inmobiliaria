const express = require('express');
const cors = require('cors');
const multer = require('multer');
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// --- Middlewares ---
app.use(cors());
app.use(express.json()); // Necesario para peticiones que no son de archivos
app.use(express.urlencoded({ extended: true })); // Para procesar datos de formularios

// Hacemos la carpeta 'uploads' pública.
// Cualquier archivo en esa carpeta será accesible desde la URL del servidor.
// Ejemplo: https://mi-replit.replit.dev/uploads/nombre-del-archivo.jpg
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// --- Configuración de Multer (el gestor de subida de archivos) ---
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    // Aquí le decimos a Multer que guarde los archivos en la carpeta 'uploads' que creaste.
    cb(null, 'uploads/');
  },
  filename: function (req, file, cb) {
    // Creamos un nombre de archivo único para evitar que se sobreescriban.
    // Será algo como: 'attachment_1-1678886400000-123456789.jpg'
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({ 
    storage: storage,
    limits: { fileSize: 5 * 1024 * 1024 }, // Límite de 5MB por archivo
    fileFilter: function (req, file, cb) {
        // Aceptar solo imágenes
        if (!file.mimetype.startsWith('image/')) {
            return cb(new Error('Solo se permiten archivos de imagen.'), false);
        }
        cb(null, true);
    }
});

// --- Base de datos en memoria (para el ejemplo) ---
let anuncios = [];
let nextId = 1;

// --- Rutas de la API ---

// Ruta para OBTENER todos los anuncios
app.get('/api/anuncios', (req, res) => {
  res.json(anuncios);
});

// Ruta para CREAR un nuevo anuncio
// 1. 'upload.single('attachment_1')' es el middleware de Multer.
//    Procesa UN archivo que venga del campo del formulario con name="attachment_1".
// 2. Si todo va bien, los datos de texto estarán en 'req.body' y el archivo en 'req.file'.
app.post('/api/anuncios', upload.single('attachment_1'), (req, res) => {
    
    // Si 'fileFilter' de multer da un error, aquí lo manejamos
    if (!req.file) {
        return res.status(400).send('Error: No se ha subido la imagen principal o el archivo no es una imagen.');
    }

    try {
        console.log('Datos de texto recibidos:', req.body);
        console.log('Datos del archivo recibidos:', req.file);

        // Los datos del formulario de texto están en req.body
        const { titulo, direccion, email, descripcion, precio, habitaciones, banos, superficie } = req.body;

        // Construimos la URL pública COMPLETA de la imagen que se acaba de subir
        const imageUrl = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;

        // Creamos el nuevo objeto de anuncio
        const nuevoAnuncio = {
            id: nextId++,
            titulo,
            direccion,
            email,
            descripcion,
            precio: parseFloat(precio) || 0,
            habitaciones: parseInt(habitaciones) || 0,
            banos: parseInt(banos) || 0,
            superficie: parseInt(superficie) || 0,
            imagen: imageUrl, // ¡Guardamos la URL real de la imagen!
        };
        
        // Añadimos el anuncio al principio del array para que aparezca el primero
        anuncios.unshift(nuevoAnuncio);
        
        console.log('Anuncio creado y guardado:', nuevoAnuncio);

        // Enviamos una respuesta exitosa con el anuncio creado
        res.status(201).json(nuevoAnuncio);

    } catch (error) {
        console.error("Error procesando el anuncio:", error);
        res.status(500).send("Error interno del servidor al procesar el anuncio.");
    }
});

// --- Iniciar el servidor ---
app.listen(PORT, () => {
  console.log(`Servidor escuchando en http://localhost:${PORT}`);
});
